const fs=require("fs"),path=require("path"),MD5=require("./MD5"),Utils={byte2Mb(e){return e/1048576},byte2MbStr(e){return this.byte2Mb(e).toFixed(4)},byte2Kb(e){return e/1024},byte2KbStr(e){return this.byte2Kb(e).toFixed(2)}},FileHelper={getImageMem(e,t){return 0},getFullPath(e){return e=path.isAbsolute(e)?e:path.join(__dirname,e)},writeFile(t,s){t&&s?fs.writeFile(t,s,e=>{e?console.error(e):(console.log(s),console.log("输出结果到文件: "+t))}):console.error("writeFile: invalid params")},getObjectFromFile(e){var t,s={};return fs.existsSync(e)&&((t=this.getFileString(e))?(s=JSON.parse(t))||console.warn("getObjectFromFile: invalid object="+e):console.warn("getObjectFromFile: invalid file="+e)),s},getFileString(e){return fs.readFileSync(e).toString()},debounce(e,t=1e3){var s=null;return function(){s&&clearTimeout(s),s=setTimeout(e,t)}}},AssetSize={fileMap:null,start(e,t){!e||e.length<=0||!t||t.length<=0?console.error("Cleaner: invalid source or dest"):(this.fileMap=new Map,e=FileHelper.getFullPath(e),t=FileHelper.getFullPath(t),this.lookupAssetDir(e,null),e=this.getSortedResult(this.fileMap,e),FileHelper.writeFile(t,e))},lookupAssetDir(s,e){if(s&&fs.existsSync(s)){var r=fs.readdirSync(s);for(let e=0,t=r.length;e<t;e++){var i=r[e],i=path.join(s,i),a=fs.statSync(i);if(a.isDirectory())this.lookupAssetDir(i);else{var l=path.parse(i);let e=this.fileMap.get(l.ext);e||(e=new Map,this.fileMap.set(l.ext,e));l=FileHelper.getImageMem(i,l.ext);e.set(i,{path:i,size:a.size,memBytes:l})}}}else console.error("AssetSize: invalid srcDir="+s)},getSortedResult(e,t){let a=[],s=(e.forEach((e,t)=>{var{totalSize:s,totalMem:r,outStr:i}=this.formatByByte(e);a.push({size:parseFloat(s),mem:parseFloat(r),ext:t,count:e.size,outStr:i})}),a.sort(function(e,t){return t.size-e.size}),""),r=0;for(let e=0,t=a.length;e<t;e++){var i=a[e];s+="类型="+i.ext+", 个数="+i.count+", 占用空间="+i.size+"MB",0<i.mem&&(s+=", 预计内存="+i.mem+"MB"),s+="\n",r+=i.size}let l="占用空间: 总大小="+r.toFixed(4)+"MB, 目录="+t+"\n\n";l+=s+"\n";for(let e=0,t=a.length;e<t;e++){var n=a[e];l+=n.outStr+"\n"}return l},formatByByte(e){let s=0,r=0,i=[],a=(e.forEach(function(e,t){s+=e.size,r+=e.memBytes,i.push(e)}),i.sort(function(e,t){return t.size-e.size}),"");for(let e=0,t=i.length;e<t;e++){var l=i[e];a+="空间="+Utils.byte2KbStr(l.size)+"KB, 文件="+l.path,0<l.memBytes&&(a+=", 内存="+Utils.byte2MbStr(l.memBytes)+"MB"),a+="\n"}return s=Utils.byte2MbStr(s),r=Utils.byte2MbStr(r),{totalSize:s,totalMem:r,outStr:a}}},ResType={Image:0,ImageAtlas:1,LabelAtlas:2,Anim:3,Spine:4,Prefab:5,Fire:6,Code:7,Fnt:8},ResExt=[{name:".plist",type:ResType.ImageAtlas},{name:".fnt",type:ResType.Fnt},{name:".labelatlas",type:ResType.LabelAtlas},{name:".json",type:ResType.Spine}],AssetCheck={sourceMap:null,destMap:null,handleMap:null,resourcesDir:"resources",dynamicDirs:["resources","fishBundle"],start(e,t){var s,r,i;!e||e.length<=0||!t||t.length<=0?console.error("Cleaner: invalid source or dest"):(this.sourceMap=new Map,this.destMap=new Map,this.handleMap=new Map,this.resourcesDir=path.join("/",this.resourcesDir,"/"),e=FileHelper.getFullPath(e),t=FileHelper.getFullPath(t),this.lookupAssetDir(e),{noBindMap:i,noLoadMap:s,md5Map:r}=this.compareAssets(),i=this.getSortedResult("未引用文件: 数量=",i,e,global._delete)+"\n"+this.getSortedResult("非动态调用(无需放在resources下)文件: 数量=",s,e)+"\n"+this.getSortedResult("MD5重复文件: 数量=",r,e),FileHelper.writeFile(t,i))},getSortedResult(e,t,s,r){let i=0,a=0,l=0,n="";var o,p,u=global._excludes&&new RegExp(global._excludes,"gi");let h=0,m=0,d="",c=!1;const g=FileHelper.debounce(()=>{var e=`共删除${h}个原始资源
`;d=e+d,c?FileHelper.writeFile(s+"\\cleanFiles.txt",d):c=!0}),y=FileHelper.debounce(()=>{var e=`共删除${m}个meta资源
`;d=e+d,c?FileHelper.writeFile(s+"\\cleanFiles.txt",d):c=!0});for([o,p]of t.entries())if(!(p.length<=0)){p.sort((e,t)=>t.size-e.size);for(let e=0,t=p.length;e<t;e++){let t=p[e];n=(n+="空间="+Utils.byte2KbStr(t.size))+("KB, 文件="+t.path),0<t.memBytes&&(l+=t.memBytes,n+=", 内存="+Utils.byte2MbStr(t.memBytes)+"MB"),n+="\n",a+=t.size;var f=u&&-1!==t.path.search(u),M=t.path.includes(this.resourcesDir);!r||M||f||(fs.unlink(t.path,e=>{if(e)return console.error(e.message);d+=t.path+"\n",h++,g()}),fs.unlink(t.path+".meta",e=>{if(e)return console.warn(e.message);d+=t.path+".meta\n",m++,y()}))}i+=p.length,n+="\n"}return e=(e+=i)+(", 占用空间="+Utils.byte2MbStr(a)+"MB, 目录="+s),0<l&&(e+=", 预计内存="+Utils.byte2MbStr(l)+"MB"),e=(e+="\n\n")+n,r&&n&&(e+=`
如果终端未显示错误，则未引用文件已全部删除(包含meta文件，不包含排除文件)
`),e},compareAssets(){var t,s,r=new Map,i=new Map,a=new Map;for([t,s]of this.sourceMap.entries()){let e=!1;var l=this.isDynamicDir(t),n=this.findAssetByUUID(t,s);if(l&&(e=this.findAssetByName(t,s)),n||e||l){if(l&&n&&!e){let e=i.get(s.type);e||(e=[],i.set(s.type,e));l=FileHelper.getImageMem(t,s.ext);e.push({path:t,size:s.size,memBytes:l})}}else{let e=r.get(s.type);e||(e=[],r.set(s.type,e));n=FileHelper.getImageMem(t,s.ext);e.push({path:t,size:s.size,memBytes:n})}if(!s.handled&&s.md5Str&&0<s.md5Str.length)for(var[o,p]of this.sourceMap.entries())if(t!==o&&p.md5Str&&s.md5Str===p.md5Str){let e=a.get(s.md5Str);e||(e=[{path:t,size:s.size,md5Str:s.md5Str}],a.set(s.md5Str,e)),e.push({path:o,size:p.size,md5Str:s.md5Str}),p.handled=!0}}return{noBindMap:r,noLoadMap:i,md5Map:a}},findAssetByUUID(e,s){let r=!1;if(e&&s)for(var[t,i]of this.destMap.entries())if(e!=t&&ResType.Code!==i.type&&s&&s.uuid)for(let e=0,t=s.uuid.length;e<t;e++){var a=s.uuid[e];if(0<=i.data.indexOf(a))return r=!0}return r},findAssetByName(e,t){let s=!1;if(e&&t)for(var[r,i]of this.destMap.entries())if(e!=r&&ResType.Code===i.type&&t&&t.name&&0<t.name.length&&0<=i.data.indexOf(t.name)){s=!0;break}return s},lookupAssetDir(s,e){if(s&&fs.existsSync(s)){var r=fs.readdirSync(s);for(let e=0,t=r.length;e<t;e++){var i=r[e],a=path.join(s,i);if(!this.handleMap.has(a)){var l=fs.statSync(a);if(l.isDirectory())this.lookupAssetDir(a);else{let e=null,t=[];var n=path.parse(a);if(a.includes(".json.meta"))e=FileHelper.getFileString(a),this.destMap.set(a,{data:e,type:ResType.Spine});else switch(n.ext){case".js":case".ts":e=FileHelper.getFileString(a),this.destMap.set(a,{data:e,type:ResType.Code});break;case".prefab":t=this.getFileUUID(a,n,ResType.Prefab),e={uuid:t,type:ResType.Prefab,size:l.size,name:""},this.isDynamicDir(a)&&(e.name=n.name),this.sourceMap.set(a,e),e=FileHelper.getFileString(a),this.destMap.set(a,{data:e,type:ResType.Prefab});break;case".anim":this.isDynamicDir(a)||(t=this.getFileUUID(a,n,ResType.Anim),this.sourceMap.set(a,{uuid:t,type:ResType.Anim,size:l.size})),e=FileHelper.getFileString(a),this.destMap.set(a,{data:e,type:ResType.Anim});break;case".fire":case".scene":case".mtl":e=FileHelper.getFileString(a),this.destMap.set(a,{data:e,type:ResType.Fire});break;case".png":case".jpg":case".webp":var o,p=this.getImageType(a,n);t=this.getFileUUID(a,n,p),p===ResType.Image&&(o=FileHelper.getFileString(a),o=MD5.md5(o),this.sourceMap.set(a,{uuid:t,type:p,size:l.size,ext:n.ext,md5Str:o}))}}}}}else console.error("AssetCheck: invalid srcDir="+s)},isDynamicDir(s){if(s)for(let e=0,t=this.dynamicDirs.length;e<t;e++){var r="/"+this.dynamicDirs[e]+"/";if(0<=s.indexOf(r))return!0}return!1},getImageType(s,r){let i=ResType.Image;for(let e=0,t=ResExt.length;e<t;e++){var a=ResExt[e],l=path.join(r.dir,r.name)+a.name;if(fs.existsSync(l)){i=a.type,this.handleMap.set(s,{handled:!0});break}}return i},getUUIDFromMeta(t,s){var r=[],i=FileHelper.getObjectFromFile(t);if(i&&i.subMetas){let e=i.subMetas[s];if(e&&e.uuid){t=e.uuid.substring(0);r.push(t)}else for(var a in i.subMetas)(e=i.subMetas[a])&&e.uuid&&(a=e.uuid.substring(0),r.push(a))}return r},getRawUUIDFromMeta(e){var t=[],e=FileHelper.getObjectFromFile(e);return e&&e.uuid&&(e=e.uuid.substring(0),t.push(e)),t},getPlistUUIDFromMeta(e){var t=[],s=FileHelper.getObjectFromFile(e);if(s&&s.uuid&&(e=s.uuid.substring(0),t.push(e)),s&&s.subMetas)for(var r in s.subMetas){var r=s.subMetas[r];r&&r.uuid&&(r=r.uuid.substring(0),t.push(r))}return t},getFileUUID(e,t,s){let r=[],i="";switch(s){case ResType.Image:i=e+".meta",r=this.getUUIDFromMeta(i,t.name).concat(this.getRawUUIDFromMeta(i));break;case ResType.ImageAtlas:i=path.join(t.dir,t.name)+".plist.meta",r=this.getPlistUUIDFromMeta(i);break;case ResType.LabelAtlas:i=path.join(t.dir,t.name)+".labelatlas.meta",r=this.getRawUUIDFromMeta(i);break;case ResType.Anim:i=e+".meta",r=this.getRawUUIDFromMeta(i,t.name);break;case ResType.Spine:i=path.join(t.dir,t.name)+".json.meta",r=this.getRawUUIDFromMeta(i);break;case ResType.Prefab:i=e+".meta",r=this.getRawUUIDFromMeta(i);break;case ResType.Code:r.push(t.name)}return r}},AssetClean={start(e,t,s){if(e&&t&&s)switch(console.log(`资源优化助手: 资源目录=${e}, 输出文件=${t}, 参数=`+s),s){case"-unuse":AssetCheck.start(e,t);break;case"-size":AssetSize.start(e,t);break;default:return void console.error("Unsupport args")}else console.error("Invalid args")}};module.exports=AssetClean;